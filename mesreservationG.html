<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Réservations - Guest Houses</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .user-info {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }
        .user-info h2 {
            color: #333;
            margin-top: 0;
        }
        .user-info p {
            margin: 5px 0;
        }
        .reservation-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }
        .reservation-card h3 {
            color: #333;
            margin-top: 0;
        }
        .reservation-info {
            margin: 10px 0;
        }
        .reservation-info p {
            margin: 5px 0;
        }
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 20px 0;
            cursor: pointer;
        }
        .back-button:hover {
            background-color: #45a049;
        }
        .no-reservations {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .action-buttons {
            margin-top: 10px;
        }
        .action-buttons button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .modify-button {
            background-color: #007bff;
            color: white;
        }
        .modify-button:hover {
            background-color: #0056b3;
        }
        .cancel-button {
            background-color: #ff4444;
            color: white;
        }
        .cancel-button:hover {
            background-color: #cc0000;
        }
        .cancelled-message {
            color: #ff4444;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <button id="logoutButton" class="logout-button">Déconnexion</button>
    <div class="container">
        <h1>Mes Réservations - Guest Houses</h1>
        <button id="backButton" class="back-button">Retour aux Guest Houses</button>

        <!-- Section pour les informations utilisateur -->
        <div id="user-info" class="user-info">
            <!-- Les informations utilisateur seront affichées ici dynamiquement -->
        </div>

        <div id="reservations-container">
            <!-- Les réservations seront affichées ici dynamiquement -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si l'utilisateur est connecté
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Afficher les informations utilisateur
            const userInfoContainer = document.getElementById('user-info');
            userInfoContainer.innerHTML = `
                <h2>Informations de l'utilisateur</h2>
                <p><strong>Nom :</strong> ${currentUser.nom || 'Non spécifié'}</p>
                <p><strong>Prénom :</strong> ${currentUser.prenom || 'Non spécifié'}</p>
                <p><strong>Âge :</strong> ${currentUser.age || 'Non spécifié'}</p>
                <p><strong>Profession :</strong> ${currentUser.profession || 'Non spécifié'}</p>
                <p><strong>Téléphone :</strong> ${currentUser.telephone || currentUser.phone || 'Non spécifié'}</p>
                <p><strong>Email :</strong> ${currentUser.email || 'Non spécifié'}</p>`;

            const container = document.getElementById('reservations-container');
            const backButton = document.getElementById('backButton');
            
            // Récupérer les réservations de Guest Houses
            let reservations = JSON.parse(localStorage.getItem('guestHouseReservations') || '{}');
            let reservationList = Object.entries(reservations).map(([roomId, reservation]) => ({
                roomId,
                ...reservation
            }));
            
            // Filtrer les réservations expirées
            const now = new Date();
            const validReservations = reservationList.filter(reservation => {
                const checkOutDate = new Date(reservation.checkOut);
                return checkOutDate > now;
            });

            // Mettre à jour guestHouseReservations en supprimant les réservations expirées
            const updatedReservations = {};
            validReservations.forEach(reservation => {
                updatedReservations[reservation.roomId] = reservation;
            });
            localStorage.setItem('guestHouseReservations', JSON.stringify(updatedReservations));

            // Synchroniser currentUser.reservations avec guestHouseReservations
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                // Ne conserver que les réservations de guestHouseReservations
                users[userIndex].reservations = users[userIndex].reservations
                    ? users[userIndex].reservations.filter(res => validReservations.some(vr => vr.roomId === res.roomId))
                    : [];
                users[userIndex].reservations = validReservations;
                localStorage.setItem('users', JSON.stringify(users));
                currentUser.reservations = validReservations;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            // Trier les réservations valides par date d'arrivée
            validReservations.sort((a, b) => new Date(a.checkIn) - new Date(b.checkIn));

            if (validReservations.length === 0) {
                container.innerHTML = `
                    <div class="no-reservations">
                        <h2>Aucune réservation trouvée</h2>
                        <p>Vous n'avez pas encore effectué de réservation pour les Guest Houses.</p>
                    </div>
                `;
                return;
            }

            // Afficher chaque réservation avec un titre numéroté et boutons d'action
            validReservations.forEach((reservation, index) => {
                const card = document.createElement('div');
                card.className = 'reservation-card';
                card.dataset.roomId = reservation.roomId;

                const checkInDate = new Date(reservation.checkIn);
                const checkOutDate = new Date(reservation.checkOut);

                card.innerHTML = `
                    <h3>Réservation ${index + 1}: Chambre ${reservation.roomNumber || reservation.roomId}</h3>
                    <div class="reservation-info">
                        <p><strong>Nom:</strong> ${reservation.guestName || currentUser.nom || 'Non spécifié'}</p>
                        <p><strong>Email:</strong> ${reservation.email || currentUser.email || 'Non spécifié'}</p>
                        <p><strong>Activité:</strong> ${reservation.activity || currentUser.profession || 'Non spécifié'}</p>
                        <p><strong>Prix:</strong> ${reservation.roomPrice ? reservation.roomPrice + ' FCFA' : 'Non spécifié'}</p>
                        <p><strong>Détails:</strong> ${reservation.roomDetails || 'Non spécifié'}</p>
                        <p><strong>Date d'arrivée:</strong> ${checkInDate.toLocaleString()}</p>
                        <p><strong>Date de départ:</strong> ${checkOutDate.toLocaleString()}</p>
                        <p><strong>Durée:</strong> ${reservation.durationValue} ${reservation.durationType === 'hours' ? 'heures' : 'jours'}</p>
                        <p><strong>Méthode de paiement:</strong> ${reservation.paymentMethod || 'Non spécifié'}</p>
                    </div>
                    <div class="action-buttons">
                        <button class="modify-button" data-room-id="${reservation.roomId}">Modifier</button>
                        <button class="cancel-button" data-room-id="${reservation.roomId}">Annuler</button>
                    </div>
                `;

                container.appendChild(card);
            });

            // Gestion des boutons Modifier
            document.querySelectorAll('.modify-button').forEach(button => {
                button.addEventListener('click', function() {
                    const roomId = this.dataset.roomId;
                    const reservation = validReservations.find(res => res.roomId === roomId);
                    if (reservation) {
                        localStorage.setItem('reservationToEdit', JSON.stringify(reservation));
                        window.location.href = `reserv.html?room=${roomId}&container=${reservation.containerId}&edit=true`;
                    }
                });
            });

            // Gestion des boutons Annuler
            document.querySelectorAll('.cancel-button').forEach(button => {
                button.addEventListener('click', function() {
                    const roomId = this.dataset.roomId;
                    if (confirm('Voulez-vous vraiment annuler cette réservation ?')) {
                        // Supprimer la réservation de guestHouseReservations
                        const guestHouseReservations = JSON.parse(localStorage.getItem('guestHouseReservations') || '{}');
                        delete guestHouseReservations[roomId];
                        localStorage.setItem('guestHouseReservations', JSON.stringify(guestHouseReservations));

                        // Supprimer la réservation de currentUser.reservations
                        const users = JSON.parse(localStorage.getItem('users') || '[]');
                        const userIndex = users.findIndex(u => u.email === currentUser.email);
                        if (userIndex !== -1) {
                            users[userIndex].reservations = users[userIndex].reservations.filter(res => res.roomId !== roomId);
                            localStorage.setItem('users', JSON.stringify(users));
                            currentUser.reservations = users[userIndex].reservations;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        }

                        // Mettre à jour l'affichage
                        const card = this.closest('.reservation-card');
                        card.innerHTML = `<div class="cancelled-message">Réservation annulée</div>`;
                        setTimeout(() => {
                            card.remove();
                            if (!container.querySelector('.reservation-card')) {
                                container.innerHTML = `
                                    <div class="no-reservations">
                                        <h2>Aucune réservation trouvée</h2>
                                        <p>Vous n'avez pas encore effectué de réservation pour les Guest Houses.</p>
                                    </div>
                                `;
                            }
                        }, 2000);
                    }
                });
            });

            // Gestion du bouton retour
            backButton.addEventListener('click', function() {
                const lastReservation = validReservations[validReservations.length - 1];
                if (lastReservation) {
                    localStorage.setItem('tempGuestHouseReservation', JSON.stringify(lastReservation));
                    window.location.href = `gesthourse.html?highlight=${lastReservation.roomId}&container=${lastReservation.containerId}`;
                } else {
                    window.location.href = 'gesthourse.html';
                }
            });

            // Gestion de la déconnexion
            const logoutButton = document.getElementById('logoutButton');
            logoutButton.addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>